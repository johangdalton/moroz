server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /var/lib/promtail/positions.yaml

clients:
  - url: http://127.0.0.1:3100/loki/api/v1/push

scrape_configs:
  # Moroz event files
  - job_name: moroz-events
    pipeline_stages:
      - regex:
          source: filename
          expression: '/var/log/moroz/(?P<file_sha>[^/]+)/(?P<machine_id>[^/]+)/'
      - labels:
          machine_id:
      - json:
          expressions:
            decision: decision
            executing_user: executing_user
            team_id: team_id
            file_bundle_id: file_bundle_id
            file_name: file_name
            file_path: file_path
            signing_id: signing_id
            cdhash: cdhash
      - labels:
          decision:
          executing_user:
          team_id:
          file_bundle_id:
          file_name:
          signing_id:
          cdhash:
    static_configs:
      - targets: [localhost]
        labels:
          job: moroz-events
          __path__: /var/log/moroz/**/*.json

  # nginx access/error logs for Santa
  - job_name: nginx
    static_configs:
      - targets: [localhost]
        labels:
          job: nginx-access
          __path__: /var/log/nginx/access.log
      - targets: [localhost]
        labels:
          job: nginx-error
          __path__: /var/log/nginx/error.log

  # Jamf inventory (enriched machine metadata)
  - job_name: jamf-inventory
    static_configs:
      - targets: [localhost]
        labels:
          job: jamf-inventory
          source: jamf
          __path__: /var/log/jamf/jamf_machines.log
    pipeline_stages:
      - json:
          expressions:
            machine_id: machine_id
            hostname: name
            serial_number: serial_number
            model: model
            os_version: os_version
            username: username
            email: email
            department_id: department_id
            department_name: department_name
            last_contact: last_contact
      - labels:
          machine_id:
          hostname:
          serial_number:
          username:
          department_id:
          department_name:

  # Moroz preflight logs from systemd journal
  - job_name: moroz-preflight
    journal:
      json: false
      max_age: 12h
      path: /var/log/journal
      labels:
        job: moroz-preflight
    pipeline_stages:
      # Step 1: Extract MESSAGE field from journal
      - json:
          expressions:
            message: MESSAGE
            unit: _SYSTEMD_UNIT

      # Step 2: Parse message as JSON and extract fields (only for structured logs)
      - json:
          source: message
          expressions:
            event_type: event_type
            machine_id: machine_id
            hostname: hostname
            serial_number: serial_number
            santa_version: santa_version
            client_mode: client_mode
            os_version: os_version
            os_build: os_build
            primary_user: primary_user

      # Step 3: Add labels for preflight events
      - labels:
          event_type:
          machine_id:
          serial_number:

    relabel_configs:
      - source_labels: ['__journal__systemd_unit']
        regex: 'moroz.service'
        action: keep
